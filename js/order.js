document.addEventListener("DOMContentLoaded", function() {
    loadOrders();
    
    setupFilterButtons();
    
    updateCartCount();
});

function loadOrders(filter = 'all') {
    const orderListContainer = document.getElementById('order-list');
    const orders = JSON.parse(localStorage.getItem('orders') || '[]');
    
    const filteredOrders = filter === 'all' 
        ? orders 
        : orders.filter(order => order.status === filter);
    
    filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (filteredOrders.length === 0) {
        orderListContainer.innerHTML = `
            <div class="empty-orders">
                <i>üì¶</i>
                <h3>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</h3>
                <p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o trong danh s√°ch n√†y.</p>
                <a href="index.html" class="continue-shopping-btn">Ti·∫øp t·ª•c mua s·∫Øm</a>
            </div>
        `;
        return;
    }
    
    let ordersHTML = '';
    
    filteredOrders.forEach(order => {
        let statusClass = '';
        switch (order.status) {
            case 'Ch·ªù x·ª≠ l√Ω':
                statusClass = 'pending';
                break;
            case 'ƒêang giao':
                statusClass = 'shipping';
                break;
            case 'ƒê√£ ho√†n th√†nh':
                statusClass = 'completed';
                break;
            case 'ƒê√£ h·ªßy':
                statusClass = 'cancelled';
                break;
            default:
                statusClass = 'pending';
        }
        
        const displayItems = order.items.slice(0, 2);
        const remainingItems = order.items.length - 2;
        
        let productsHTML = '';
        displayItems.forEach(item => {
            productsHTML += `
                <div class="order-product">
                    <img src="${item.image}" alt="${item.name}" class="product-image">
                    <div class="product-info">
                        <h4>${item.name}</h4>
                        <p>${item.color || ''} ${item.storage || ''}</p>
                        <p>${item.quantity} x ${formatCurrency(item.price)}</p>
                    </div>
                </div>
            `;
        });
        
      if (remainingItems > 0) {
            productsHTML += `
                <div class="more-products">
                    v√† ${remainingItems} s·∫£n ph·∫©m kh√°c
                </div>
            `;
        }
        
        ordersHTML += `
            <div class="order-card">
                <div class="order-header">
                    <div class="order-info">
                        <div class="order-id">ƒê∆°n h√†ng #${order.id}</div>
                        <div class="order-date">${new Date(order.date).toLocaleDateString('vi-VN')}</div>
                    </div>
                    <div class="order-status ${statusClass}">${order.status}</div>
                </div>
                <div class="order-content">
                    <div class="order-products">
                        ${productsHTML}
                    </div>
                    <div class="order-summary">
                        <div class="order-total">
                            T·ªïng ti·ªÅn: <span class="total-amount">${formatCurrency(order.total)}</span>
                        </div>
                        <div class="order-actions">
                            <a href="chitietdonhang.html?id=${order.id}" class="view-detail-btn">Xem chi ti·∫øt</a>
                            ${order.status === 'Ch·ªù x·ª≠ l√Ω' ? `<button class="cancel-btn" onclick="cancelOrder('${order.id}')">H·ªßy ƒë∆°n h√†ng</button>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    orderListContainer.innerHTML = ordersHTML;
}

function setupFilterButtons() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            loadOrders(filter);
        });
    });
}

function cancelOrder(orderId) {
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?")) {
        let orders = JSON.parse(localStorage.getItem("orders") || "[]");
        
        const orderIndex = orders.findIndex(order => order.id === orderId);
        
        if (orderIndex !== -1) {
            orders[orderIndex].status = "ƒê√£ h·ªßy";
            
            localStorage.setItem("orders", JSON.stringify(orders));
            
            loadOrders();
            
            alert("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy th√†nh c√¥ng!");
        }
    }
}

function buyAgain(orderId) {
  const orders = JSON.parse(localStorage.getItem("orders") || "[]");
  
  const order = orders.find(order => order.id === orderId);
  
  if (!order || !order.items) {
    alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng!");
    return;
  }
  
  // L·∫•y g·ªè h√†ng hi·ªán t·∫°i
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  
  // Th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng
  order.items.forEach(item => {
    // Ki·ªÉm tra xem s·∫£n ph·∫©m ƒë√£ c√≥ trong gi·ªè h√†ng ch∆∞a
    const existingItemIndex = cart.findIndex(cartItem => 
      cartItem.id === item.id && 
      cartItem.color === item.color && 
      cartItem.storage === item.storage
    );
    
    if (existingItemIndex !== -1) {
      // N·∫øu ƒë√£ c√≥, tƒÉng s·ªë l∆∞·ª£ng
      cart[existingItemIndex].quantity += (item.quantity || 1);
    } else {
      // N·∫øu ch∆∞a c√≥, th√™m m·ªõi
      cart.push({
        id: item.id,
        name: item.name || item.tensanpham,
        price: item.price || item.dongia,
        image: item.image || item.hinhanh || "anh/default-product.png",
        quantity: item.quantity || item.soluong || 1,
        color: item.color,
        storage: item.storage
      });
    }
  });
  
  localStorage.setItem("cart", JSON.stringify(cart));
  
  updateCartCount();
  
  alert("ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!");
  
  window.location.href = "giohang.html";
}

function trackOrder(orderId) {
  const trackingData = [
    { status: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n", location: "Kho h√†ng trung t√¢m", time: "10:30 25/05/2023" },
    { status: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë√≥ng g√≥i", location: "Kho h√†ng trung t√¢m", time: "15:45 25/05/2023" },
    { status: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao cho ƒë∆°n v·ªã v·∫≠n chuy·ªÉn", location: "Kho h√†ng trung t√¢m", time: "08:15 26/05/2023" },
    { status: "ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c v·∫≠n chuy·ªÉn", location: "Trung t√¢m ph√¢n ph·ªëi", time: "14:20 26/05/2023" },
    { status: "ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c giao ƒë·∫øn ƒë·ªãa ch·ªâ c·ªßa b·∫°n", location: "ƒêang giao", time: "09:30 27/05/2023" }
  ];
  
  const trackingHtml = `
    <div class="tracking-modal">
      <div class="tracking-content">
        <div class="tracking-header">
          <h2>Theo d√µi ƒë∆°n h√†ng #${orderId}</h2>
          <span class="close-tracking">&times;</span>
        </div>
        <div class="tracking-body">
          <div class="tracking-timeline">
            ${trackingData.map(update => `
              <div class="timeline-item">
                <div class="timeline-time">${update.time}</div>
                <div class="timeline-content">
                  <div class="timeline-status">${update.status}</div>
                  <div class="timeline-location">${update.location}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
  
  const trackingModal = document.createElement('div');
  trackingModal.innerHTML = trackingHtml;
  document.body.appendChild(trackingModal);
  
  document.querySelector('.close-tracking').addEventListener('click', function() {
    document.body.removeChild(trackingModal);
  });
}

function updateCartCount() {
  const cart = JSON.parse(localStorage.getItem("cart") || "[]");
  const count = cart.reduce((total, item) => total + (parseInt(item.quantity) || 1), 0);
  
  const cartCountElement = document.querySelector(".cart-count");
  if (cartCountElement) {
    cartCountElement.textContent = count;
  }
}

function checkLoginStatus() {
  const user = JSON.parse(localStorage.getItem("user") || "{}");
  
  if (!user.isLoggedIn) {
    window.location.href = "dangnhap.html";
  }
}

function updateUserUI() {
  const user = JSON.parse(localStorage.getItem("user") || "{}");
  const usernameDisplay = document.getElementById("usernameDisplay");
  const userAvatar = document.getElementById("userAvatar");

  if (user.isLoggedIn && usernameDisplay) {
    usernameDisplay.textContent = user.username || "T√†i kho·∫£n";
    if (user.avatar && userAvatar) {
      userAvatar.src = user.avatar;
    } else if (userAvatar) {
      userAvatar.src = "anh/avatar.png";
    }

    const loginLink = document.getElementById("login-link");
    const registerLink = document.getElementById("register-link");
    const logoutLink = document.getElementById("logout-link");
    const orderHistoryLink = document.getElementById("order-history-link");

    if (loginLink) loginLink.style.display = "none";
    if (registerLink) registerLink.style.display = "none";
    if (logoutLink) logoutLink.style.display = "block";
    if (orderHistoryLink) orderHistoryLink.style.display = "block";
  }
}

function syncLoginInfo() {
  const loggedInUser = localStorage.getItem("loggedInUser");
  const user = JSON.parse(localStorage.getItem("user") || "{}");
  
  if (loggedInUser && !user.isLoggedIn) {
    localStorage.setItem("user", JSON.stringify({
      id: Date.now(), 
      username: loggedInUser,
      isLoggedIn: true
    }));
  } 
  else if (user.isLoggedIn && !loggedInUser) {
    localStorage.setItem("loggedInUser", user.username);
  }

  updateUserUI();
}

function formatCurrency(amount) {
  return new Intl.NumberFormat("vi-VN", {
    style: "currency",
    currency: "VND",
  }).format(amount);
}

function cancelOrder(orderId) {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?")) {
    let orders = JSON.parse(localStorage.getItem("orders") || "[]");
    
    const orderIndex = orders.findIndex(order => order.id === orderId);
    
    if (orderIndex !== -1) {
      orders[orderIndex].status = "ƒê√£ h·ªßy";
      localStorage.setItem("orders", JSON.stringify(orders));
      
      loadOrders();
      
      alert("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy th√†nh c√¥ng!");
    }
  }
}

function buyAgain(orderId) {
  const orders = JSON.parse(localStorage.getItem("orders") || "[]");
  const order = orders.find(order => order.id === orderId);
  if (!order || !order.items) {
    alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng!");
    return;
  }
  
  let cart = JSON.parse(localStorage.getItem("cart") || "[]");
  
  order.items.forEach(item => {
    const existingItemIndex = cart.findIndex(cartItem => 
      cartItem.id === item.id && 
      cartItem.color === item.color && 
      cartItem.storage === item.storage
    );
    
    if (existingItemIndex !== -1) {
      cart[existingItemIndex].quantity += (item.quantity || 1);
    } else {
      cart.push({
        id: item.id,
        name: item.name || item.tensanpham,
        price: item.price || item.dongia,
        image: item.image || item.hinhanh || "anh/default-product.png",
        quantity: item.quantity || item.soluong || 1,
        color: item.color,
        storage: item.storage
      });
    }
  });
  
  localStorage.setItem("cart", JSON.stringify(cart));
  
  updateCartCount();
  
  alert("ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!");
  
  window.location.href = "giohang.html";
}

function trackOrder(orderId) {
  const trackingData = [
    { status: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n", location: "Kho h√†ng trung t√¢m", time: "10:30 25/05/2023" },
    { status: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë√≥ng g√≥i", location: "Kho h√†ng trung t√¢m", time: "15:45 25/05/2023" },
    { status: "ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c giao cho ƒë∆°n v·ªã v·∫≠n chuy·ªÉn", location: "Kho h√†ng trung t√¢m", time: "08:15 26/05/2023" },
    { status: "ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c v·∫≠n chuy·ªÉn", location: "Trung t√¢m ph√¢n ph·ªëi", time: "14:20 26/05/2023" },
    { status: "ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c giao ƒë·∫øn ƒë·ªãa ch·ªâ c·ªßa b·∫°n", location: "ƒêang giao", time: "09:30 27/05/2023" }
  ];
  
  const trackingHtml = `
    <div class="tracking-modal">
      <div class="tracking-content">
        <div class="tracking-header">
          <h2>Theo d√µi ƒë∆°n h√†ng #${orderId}</h2>
          <span class="close-tracking">&times;</span>
        </div>
        <div class="tracking-body">
          <div class="tracking-timeline">
            ${trackingData.map(update => `
              <div class="timeline-item">
                <div class="timeline-time">${update.time}</div>
                <div class="timeline-content">
                  <div class="timeline-status">${update.status}</div>
                  <div class="timeline-location">${update.location}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
  
  const trackingModal = document.createElement('div');
  trackingModal.innerHTML = trackingHtml;
  document.body.appendChild(trackingModal);
  
  document.querySelector('.close-tracking').addEventListener('click', function() {
    document.body.removeChild(trackingModal);
  });
}








