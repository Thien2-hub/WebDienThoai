<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="style/style_thanhtoan.css" />
    <title>Thanh To√°n</title>
  </head>
  <body>
    <header>
      <div class="daudo">
        <div class="dau">
          <div class="logo">
            <a href="index.html">NH<span class="chu_o">o</span>M7</a>
          </div>
          <div class="search-container">
            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input
                type="text"
                placeholder="T√¨m ki·∫øm ·ªü ƒë√¢y"
                id="searchInput"
              />
              <button id="searchButton">T√¨m Ki·∫øm</button>
            </div>
          </div>
        </div>
        <div class="giohang_taikhoan">
          <a href="giohang.html" class="giohang_taikhoan-item">
            <div class="giohang-icon">
              üõí
              <span class="cart-count">0</span>
            </div>
            <p>Gi·ªè H√†ng</p>
          </a>

          <a href="taikhoan.html" class="giohang_taikhoan-item">
            <img
              id="userAvatar"
              class="user-avatar"
              src="anh/avatar.png"
              alt="Avatar"
            />
            <p id="usernameDisplay">T√†i kho·∫£n</p>
          </a>
        </div>
      </div>
    </header>

    <main>
      <div
        class="breadcrumb"
        style="font-family: 'Inter', sans-serif; margin-top: 20px"
      >
        <a
          href=""
          style="
            font-size: 32px;
            padding-right: 10px;
            color: black;
            font-weight: bold;
          "
          >THANH TO√ÅN</a
        >
        <a
          href="index.html"
          style="color: rgba(0, 0, 0, 0.388); font-size: 12px"
          >TRANG CH·ª¶</a
        >
        /
        <span style="color: black; font-weight: bold; font-size: 14px"
          >THANH TO√ÅN</span
        >
      </div>

      <div class="checkout-container">
        <div class="checkout-form">
          <h2>Th√¥ng tin thanh to√°n</h2>
          <form id="checkout-form" class="checkout-form">
            <div class="form-group">
              <label for="fullname">H·ªç v√† t√™n:</label>
              <input type="text" id="fullname" name="fullname" required />
            </div>
            <div class="form-group">
              <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
              <input
                type="tel"
                id="phone"
                name="phone"
                pattern="[0-9]{10}"
                required
              />
            </div>
            <div class="form-group">
              <label for="email">Email:</label>
              <input type="email" id="email" name="email" required />
            </div>
            <div class="form-group">
              <label for="address">ƒê·ªãa ch·ªâ:</label>
              <textarea id="address" name="address" required></textarea>
            </div>
            <div class="form-group">
              <label for="payment">Ph∆∞∆°ng th·ª©c thanh to√°n:</label>
              <select id="payment" name="payment" required>
                <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n --</option>
                <option value="cod">Thanh to√°n khi nh·∫≠n h√†ng (COD)</option>
                <option value="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                <option value="momo">V√≠ ƒëi·ªán t·ª≠ MoMo</option>
              </select>
            </div>
            <div class="form-group">
              <label for="note">Ghi ch√∫:</label>
              <textarea id="note" name="note"></textarea>
            </div>
            <div class="form-group checkbox">
              <input
                type="checkbox"
                id="agreeTerms"
                name="agreeTerms"
                required
              />
              <label for="agreeTerms"
                >T√¥i ƒë·ªìng √Ω v·ªõi <a href="#">ƒëi·ªÅu kho·∫£n v√† ƒëi·ªÅu ki·ªán</a></label
              >
            </div>
            <button type="button" id="placeOrder" disabled>ƒê·∫∂T H√ÄNG</button>
          </form>
        </div>

        <div class="order-summary">
          <h2>ƒê∆°n h√†ng c·ªßa b·∫°n</h2>
          <div id="order-items">

          </div>
          <div class="total">
            <p>T·ªïng c·ªông: <span id="total-price">0</span> VND</p>
          </div>
        </div>
      </div>
    </main>

    <footer>

    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let loggedInUser = localStorage.getItem("loggedInUser");
        if (!loggedInUser) {
          alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c thanh to√°n!");
          window.location.href = "dangnhap.html?redirect=thanhtoan.html";
          return;
        }

        let users = JSON.parse(localStorage.getItem("users")) || [];
        let currentUser = users.find((user) => user.username === loggedInUser);

        if (currentUser) {
          document.getElementById("fullname").value =
            currentUser.fullname || "";
          document.getElementById("phone").value = currentUser.sdt || "";
          document.getElementById("email").value = currentUser.email || "";
          document.getElementById("address").value = currentUser.address || "";
        }

        loadOrder();
      });

      function loadOrder() {
        let cart = JSON.parse(localStorage.getItem("checkoutCart")) || [];

        if (cart.length === 0) {
          document.getElementById("order-items").innerHTML =
            "<p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng.</p>";
          document.getElementById("placeOrder").disabled = true;
          return;
        }

        let totalPrice = 0;
        let orderContainer = document.getElementById("order-items");
        orderContainer.innerHTML = "";

        cart.forEach((product) => {
          totalPrice += product.price * product.quantity;
          orderContainer.innerHTML += `
                    <div class="order-item">
                        <img src="${product.image}" alt="${
            product.name
          }" width="80">
                        <div class="item-details">
                            <p class="product-name">${product.name} - ${
            product.storage
          }</p>
                            <p class="product-color">M√†u: ${
                              product.color || "N/A"
                            }</p>
                            <p class="product-price">${
                              product.quantity
                            } x ${product.price.toLocaleString()} VND</p>
                        </div>
                    </div>
                `;
        });

        document.getElementById("total-price").innerText =
          totalPrice.toLocaleString();
      }

      document
        .getElementById("agreeTerms")
        .addEventListener("change", function () {
          document.getElementById("placeOrder").disabled = !this.checked;
        });
        

      document
        .getElementById("placeOrder")
        .addEventListener("click", function () {
          let cart = JSON.parse(localStorage.getItem("checkoutCart")) || [];

          if (cart.length === 0) {
            alert("Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng!");
            return;
          }
          

          let form = document.getElementById("checkout-form");
          let formValid = true;

          form.querySelectorAll("[required]").forEach((field) => {
            if (!field.value.trim()) {
              formValid = false;
              field.classList.add("error");
            } else {
              field.classList.remove("error");
            }
          });

          if (!formValid) {
            alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin thanh to√°n!");
            return;
          }
let orderInfo = {
    id: "DH" + Date.now(), 
    fullname: document.getElementById("fullname").value,
    phone: document.getElementById("phone").value,
    email: document.getElementById("email").value,
    address: document.getElementById("address").value,
    payment: document.getElementById("payment").value,
    note: document.getElementById("note").value,
    date: new Date().toLocaleString(),
    status: "Ch·ªù x·ª≠ l√Ω",
    items: cart,
    totalAmount: cart.reduce(
      (sum, item) => sum + item.price * item.quantity,
      0
    ),
    username: localStorage.getItem("loggedInUser")
};

          let orders = JSON.parse(localStorage.getItem("orders")) || [];
          orders.push(orderInfo);
          localStorage.setItem("orders", JSON.stringify(orders));
          localStorage.removeItem("checkoutCart");
          let mainCart = JSON.parse(localStorage.getItem("cart")) || [];
          cart.forEach((checkoutItem) => {
            mainCart = mainCart.filter(
              (cartItem) =>
                !(
                  cartItem.name === checkoutItem.name &&
                  cartItem.storage === checkoutItem.storage &&
                  cartItem.color === checkoutItem.color
                )
            );
          });
          localStorage.setItem("cart", JSON.stringify(mainCart));

          alert("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
          window.location.href = "donhang.html";
          
        });
    </script>
    <script src="script/count.js"></script>
  </body>
</html>